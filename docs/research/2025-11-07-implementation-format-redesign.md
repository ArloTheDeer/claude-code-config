# Implementation.md 格式重新設計研究

## 執行摘要

本研究針對 `create-impl-plan` 指令產生的 `implementation.md` 檔案格式進行分析與重新設計。當前格式在實際使用中遇到了幾個關鍵痛點：任務編號系統在需要插入新任務時造成維護困難、缺乏實作過程的上下文記錄機制、以及缺少文件更新的明確指引。

經過分析，我們提出了三個主要改進方向：

1. **無編號任務系統**：採用「任務概要 + 任務細節」的雙層結構，在保持可讀性的同時提升靈活性
2. **實作上下文記錄**：在每個任務中加入「實作備註」區域，為跨對話框執行提供必要的上下文承接
3. **文件更新任務**：明確要求在驗收測試後更新專案文件，確保文件與實作保持同步

這些改進將使 `implementation.md` 更適合實際的開發工作流程，特別是在需要跨多個 Claude Code 對話框執行的長期專案中。

## 背景與脈絡

claude-code-config 專案建立了一個三步驟的開發工作流程：需求澄清（`/create-prd`）→ 實作規劃（`/create-impl-plan`）→ 任務執行（`/process-task-list`）。在這個流程中，`implementation.md` 扮演了關鍵的橋接角色，它將 PRD 中的高層次需求轉換成具體可執行的任務清單。

當前的 `implementation.md` 格式在專案初期設計時，主要聚焦在任務的完整性和結構化呈現。然而，在實際使用過程中，幾個實務問題逐漸浮現：

首先，任務編號系統雖然提供了清晰的順序，但在開發過程中需要頻繁調整。例如，在執行任務 3 時發現需要額外的準備工作，理想情況是插入一個新任務 3.5，但現有的編號系統會迫使我們重新編號所有後續任務，造成維護負擔。

其次，當 context size 接近上限時，需要開啟新的 Claude Code 對話框繼續執行任務。此時，新對話框缺乏前一個對話框累積的上下文資訊，特別是關於「為什麼某個實作決策被調整」的脈絡。這種上下文的斷裂會導致重複的問題分析，甚至可能做出與前期決策相矛盾的選擇。

最後，在完成功能實作和驗收測試後，專案文件（如 README.md、CLAUDE.md）往往沒有被及時更新。這導致文件與實際功能產生落差，影響後續開發者的理解和使用。

這些問題的共同根源在於：當前的 `implementation.md` 格式更像是一份「規劃清單」，而非一份「活文件」。它需要在保持結構化的同時，能夠適應實作過程中的動態調整，並記錄關鍵的實作決策脈絡。

## 研究問題與發現過程

### 初始請求分析

使用者提出了三個具體的改進需求：

1. **移除任務編號**：避免插入新任務時需要重新編號所有後續任務
2. **加入實作備註區域**：記錄任務執行過程中的調整和重要上下文
3. **增加文件更新任務**：確保專案文件與實作保持同步

這些需求背後反映的核心問題是：現有格式在「可維護性」和「上下文保存」方面存在不足。

### 問題深化

為了更好地理解改進方向，需要考慮以下問題：

1. **任務識別性**：移除編號後，如何在討論中清楚地指涉特定任務？
2. **閱讀體驗**：雙層結構（概要 + 細節）是否會增加閱讀負擔？
3. **工具整合**：新格式需要如何與 TodoWrite 工具整合？
4. **向後相容**：現有的 `/process-task-list` 指令是否需要調整？

## 技術分析：深入理解問題

### 程式碼庫現況探索

檢視現有的 `implementation.md` 範例（如 `reference/2025-08-29-notes-url-mapping/implementation.md`）後，發現幾個關鍵特徵：

**任務結構**：採用編號條列式（1, 2, 3...），每個任務包含子任務（1.1, 1.2, 1.3...）。這種結構在初期規劃時很清晰，但在實作過程中出現了「Follow-up 修復任務」區塊，顯示原始編號系統無法容納動態變化。

**相關檔案區塊**：所有任務共用一個「相關檔案」清單，這導致無法清楚識別某個特定任務實際需要修改哪些檔案。在執行時需要開發者自行判斷，增加了認知負擔。

**TDD 標註**：部分任務標註「使用 TDD 開發流程」，但這個標註與任務內容是平行的，缺乏結構化整合。

**缺少上下文記錄機制**：當任務執行遇到問題時（如驗收測試失敗），會在文件中動態增加新任務（如任務 7-13），但這些任務與原始規劃的關聯性不夠明確，且缺少「為什麼需要這些任務」的脈絡說明。

### 問題根源追蹤

**編號系統的剛性**：編號系統假設任務序列在規劃階段就已經確定，但實際開發過程是動態的。當需要插入新任務時，有兩種不良選擇：
- 重新編號所有後續任務（維護成本高）
- 使用非連續編號（如 7, 8, 9 之後突然出現 12，破壞了連貫性）

**上下文斷裂問題**：當 Claude Code 因 context size 限制需要切換對話框時，新對話框只能看到 `implementation.md` 的靜態內容，無法得知前一個對話框中發生的問題、嘗試的解決方案、以及關鍵的技術決策。這種資訊的遺失會導致：
- 重複犯相同的錯誤
- 做出與前期決策矛盾的選擇
- 需要重新分析已經解決的問題

**文件同步缺失**：專案文件（README、CLAUDE.md）沒有被納入實作流程的明確步驟中，導致文件更新經常被遺忘或延後。

### 業界智慧與最佳實踐

調研 GitHub Issues、Jira、Linear 等專案管理工具後發現幾個共通模式：

**任務識別**：使用標題而非編號作為任務的主要識別方式。編號通常是系統自動生成的 ID（如 JIRA-1234），而非手動維護的序號。

**雙層呈現**：提供「簡潔視圖」（task list）和「詳細視圖」（task detail）的切換，讓使用者可以根據需要選擇閱讀深度。

**活動記錄**：任務中包含「活動歷史」或「評論」區域，記錄執行過程中的討論、決策和調整。

**檢查清單模式**：使用 checkbox 標記任務狀態，這與 Markdown 的 task list 語法完全相容。

## 解決方案探索與評估

### 方案一：完全移除編號，僅使用標題

**核心理念**：完全依賴任務標題進行識別，不使用任何數字編號。

```markdown
## 任務

- [ ] 設定 Next.js 靜態輸出模式
  - 修改 `next.config.ts` 加入 `output: 'export'` 設定
  - 設定 `trailingSlash: true` 以支援靜態檔案結構

- [ ] 建立檔案掃描和路由生成工具 - 使用 TDD 開發流程
  - 實作 `lib/notes.ts` 中的檔案掃描功能
  - 實作路徑映射邏輯
```

**評估**：
- **可讀性**：✓ 清晰簡潔
- **靈活性**：✓ 插入新任務無需重新編號
- **引用性**：✗ 在討論中引用任務時需要使用完整標題
- **工具整合**：✓ 與 TodoWrite 工具相容

**主要問題**：當多個任務標題相似時，引用時可能產生歧義。

### 方案二：雙層結構（任務概要 + 任務細節）

**核心理念**：在文件開頭提供簡潔的任務概要列表，後續提供每個任務的詳細說明。

```markdown
## 任務概要
- [ ] 設定 Next.js 靜態輸出模式
- [ ] 建立檔案掃描和路由生成工具 - 使用 TDD 開發流程
- [ ] 建立 URL 編碼處理工具 - 使用 TDD 開發流程

## 任務細節

### 設定 Next.js 靜態輸出模式

**實作要點**
- 修改 `next.config.ts` 加入 `output: 'export'` 設定
- 設定 `trailingSlash: true` 以支援靜態檔案結構
- 測試基本的靜態建置功能

**相關檔案**
- `next.config.ts` - Next.js 設定檔

**實作備註**
<!-- 執行過程中的重要決策和調整記錄於此 -->

### 建立檔案掃描和路由生成工具 - 使用 TDD 開發流程

**實作要點**
- 實作 `lib/notes.ts` 中的檔案掃描功能
- 實作路徑映射邏輯
- 實作 `generateStaticParams` 函數

**相關檔案**
- `lib/notes.ts` - 筆記檔案處理工具
- `lib/notes.test.ts` - 單元測試檔案

**實作備註**
<!-- 執行過程中的重要決策和調整記錄於此 -->
```

**評估**：
- **可讀性**：✓ 提供快速瀏覽（概要）和深入閱讀（細節）兩種模式
- **靈活性**：✓ 插入新任務只需在兩處添加即可
- **引用性**：✓ 可以使用標題引用，在概要中也能快速定位
- **工具整合**：✓ 概要部分可與 TodoWrite 工具同步
- **上下文保存**：✓ 實作備註區域提供了記錄空間

**主要優勢**：
- 概要提供了全局視角，方便追蹤進度
- 細節區塊提供了充足的空間記錄實作資訊
- 相關檔案移到各任務中，更精確地指示範圍
- 實作備註為跨對話框執行提供了上下文承接機制

### 方案三：保留編號但使用彈性編號系統

**核心理念**：使用 10 的倍數作為主要編號（10, 20, 30...），為插入新任務保留空間。

```markdown
## 任務

- [ ] 10. 設定 Next.js 靜態輸出模式
- [ ] 20. 建立檔案掃描和路由生成工具
- [ ] 25. 建立路徑驗證工具 <!-- 後來插入的任務 -->
- [ ] 30. 建立 URL 編碼處理工具
```

**評估**：
- **可讀性**：△ 非連續編號可能造成困惑
- **靈活性**：△ 仍然有空間耗盡的風險
- **引用性**：✓ 可以使用編號快速引用
- **工具整合**：△ 需要調整 TodoWrite 工具的邏輯

**主要問題**：編號跳躍會讓人誤以為缺少任務，且彈性有限。

### 方案比較總結

| 特性 | 方案一：僅標題 | 方案二：雙層結構 | 方案三：彈性編號 |
|------|----------------|------------------|------------------|
| 可讀性 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| 維護靈活性 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| 引用便利性 | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 上下文記錄 | ⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐ |
| 工具整合 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| 實作成本 | 低 | 中 | 中 |

## 建議與決策指引

基於以上分析，**強烈推薦採用方案二：雙層結構（任務概要 + 任務細節）**。主要理由包括：

1. **完美滿足原始需求**：解決了編號維護問題、提供了上下文記錄空間、為文件更新提供了明確位置
2. **最佳的資訊架構**：概要提供快速導航，細節提供深入資訊，符合人類閱讀習慣
3. **優秀的工具整合**：概要部分可以直接與 TodoWrite 工具同步，細節部分作為實作參考
4. **可擴展性**：未來可以在任務細節中加入更多結構化資訊（如預估時間、依賴關係等）

### 實施細節建議

#### 1. 任務概要區塊

保持簡潔，僅列出任務標題和 checkbox：

```markdown
## 任務概要
- [ ] 設定 Next.js 靜態輸出模式
- [ ] 建立檔案掃描和路由生成工具 - 使用 TDD 開發流程
- [ ] 建立 URL 編碼處理工具 - 使用 TDD 開發流程
- [ ] 實作動態筆記頁面元件 - 使用 TDD 開發流程
- [ ] 建立 404 頁面處理
- [ ] 執行驗收測試
- [ ] 更新專案文件
```

#### 2. 任務細節區塊

每個任務包含三個固定子區塊：

```markdown
### 任務標題（與概要完全一致）

**實作要點**
- 具體的實作步驟和技術要求
- 詳細說明任務的範圍和目標
- 如果是 TDD 任務，說明測試重點

**相關檔案**
- `path/to/file1.ts` - 檔案用途說明
- `path/to/file2.test.ts` - 測試檔案
- `path/to/file3.tsx` - UI 元件

**實作備註**
<!--
執行過程中填寫：
- 遇到的問題和解決方案
- 重要的技術決策和理由
- 需要傳遞給下一個對話框的上下文
- 與原始計畫的調整和變更
-->
```

#### 3. 文件更新任務的標準格式

在驗收測試之後，明確加入文件更新任務：

```markdown
### 更新專案文件

**實作要點**
- 審查 README.md，根據新功能更新使用說明和功能清單
- 審查 CLAUDE.md，更新專案架構和技術考量說明
- 審查其他專案層級文件（如 API 文件、部署指南、貢獻指南等）
- 注意文件長度控制：適時摘要舊內容，抽象化技術細節
- 確保文件的準確性和一致性
- **注意**：不需要更新 docs/research 和 docs/specs 目錄中的歷史文件

**相關檔案**
- `README.md` - 專案主要說明文件
- `CLAUDE.md` - AI 助手的專案指引文件
- 其他專案層級的 `.md` 文件（根據實際需求）

**實作備註**
<!-- 記錄文件更新的重點和摘要策略 -->
```

#### 4. 實作備註的填寫指引

實作備註應該記錄：

**必須記錄**：
- 與原始計畫的重大偏離和原因
- 關鍵的技術決策（為什麼選擇 A 而非 B）
- 遇到的技術障礙和解決方案
- 需要後續任務注意的依賴或前置條件

**不需記錄**：
- 照預期完成的實作（可簡單標註「照預期開發」或留空）
- 過於細節的程式碼變更（這些在 git commit 中）
- 明顯的實作細節（如「安裝了套件 X」）
- 可從文件其他地方（PRD、implementation.md 其他章節）取得的資訊

**記錄原則**：只記錄下一個任務（或下一個對話框）會需要知道、但無法從現有文件中直接得到的上下文

#### 5. 與 TodoWrite 工具的整合

建議調整 `/process-task-list` 指令：
- 讀取「任務概要」區塊作為待辦清單
- 讀取對應的「任務細節」區塊作為任務執行指引
- 任務完成後，提示填寫「實作備註」
- 在 git commit message 中引用任務標題（而非編號）

## 風險與限制評估

### 潛在風險

1. **雙重維護負擔**：概要和細節需要保持標題一致，可能增加維護成本
   - **緩解策略**：在 `create-impl-plan` 指令中自動生成兩者，確保一致性

2. **實作備註的填寫習慣**：開發者可能忘記填寫實作備註
   - **緩解策略**：在 `process-task-list` 中加入提示機制

3. **文件長度增加**：雙層結構會讓文件變長
   - **評估**：實際增加的長度有限，且提升的可讀性值得這個成本

### 限制條件

1. **需要調整現有工具**：`create-impl-plan` 和 `process-task-list` 都需要修改
2. **向後相容性**：現有的 implementation.md 格式需要遷移指引
3. **學習曲線**：使用者需要理解新的雙層結構

## 下一步行動計畫

建議按照以下順序執行改進：

### 立即行動

1. **建立新格式範例**：在 `reference/2025-08-29-notes-url-mapping/` 中建立 `implementation-future.md`，展示新格式的完整結構
2. **驗證可讀性**：與使用者確認新格式是否符合預期，收集回饋

### 中期目標

3. **修改 `create-impl-plan.md`**：更新指令模板，使其生成新格式的 implementation.md
4. **更新 `process-task-list.md`**：調整任務執行流程，整合實作備註填寫機制
5. **建立遷移指引**：為現有專案提供從舊格式遷移到新格式的步驟

### 長期規劃

6. **評估自動化機會**：考慮開發工具自動檢查概要與細節的一致性
7. **收集使用回饋**：在實際使用幾個專案後，評估是否需要微調格式
8. **文件化最佳實踐**：建立「如何寫好實作備註」的指引文件

## 參考資料

### 專案管理工具模式
- GitHub Issues 的 task list 語法
- Linear 的 issue 詳細頁面設計
- Jira 的 activity log 機制

### Markdown 最佳實踐
- CommonMark 規範中的 task list 擴展
- 技術文件寫作中的資訊分層原則

### 現有實作範例
- `reference/2025-08-29-notes-url-mapping/implementation.md` - 當前格式範例
- `reference/2025-08-28-copy-obsidian-vault/implementation.md` - 簡單專案範例
